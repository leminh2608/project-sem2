<!DOCTYPE html>
<html>
<head>
    <title>Login Test</title>
</head>
<body>
    <h1>Login Test</h1>
    <button onclick="testLogin()">Test Login</button>
    <div id="results"></div>

    <script>
        async function testLogin() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Testing login...</p>';
            
            try {
                // Step 1: Get CSRF token
                console.log('Getting CSRF token...');
                const csrfResponse = await fetch('/api/auth/csrf');
                const csrfData = await csrfResponse.json();
                console.log('CSRF data:', csrfData);
                
                if (!csrfData.csrfToken) {
                    results.innerHTML += '<p>❌ No CSRF token</p>';
                    return;
                }
                
                // Step 2: Attempt login
                console.log('Attempting login...');
                const loginResponse = await fetch('/api/auth/signin/credentials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        email: 'admin@example.com',
                        password: 'admin123',
                        csrfToken: csrfData.csrfToken,
                        callbackUrl: '/admin',
                        json: 'true'
                    })
                });
                
                console.log('Login response status:', loginResponse.status);
                const loginData = await loginResponse.json();
                console.log('Login response data:', loginData);
                
                results.innerHTML += `<p>Login status: ${loginResponse.status}</p>`;
                results.innerHTML += `<p>Login data: ${JSON.stringify(loginData)}</p>`;
                
                // Step 3: Check session
                console.log('Checking session...');
                const sessionResponse = await fetch('/api/auth/session');
                const sessionData = await sessionResponse.json();
                console.log('Session data:', sessionData);
                
                results.innerHTML += `<p>Session: ${JSON.stringify(sessionData, null, 2)}</p>`;
                
                if (sessionData.user && sessionData.user.role) {
                    results.innerHTML += `<p>✅ Success! User role: ${sessionData.user.role}</p>`;
                    
                    // Test redirect
                    const redirectUrl = sessionData.user.role === 'admin' ? '/admin' : 
                                       sessionData.user.role === 'teacher' ? '/teacher/dashboard' :
                                       '/student/dashboard';
                    
                    results.innerHTML += `<p>Would redirect to: ${redirectUrl}</p>`;
                    results.innerHTML += `<p><a href="${redirectUrl}">Go to Dashboard</a></p>`;
                } else {
                    results.innerHTML += '<p>❌ No user session found</p>';
                }
                
            } catch (error) {
                console.error('Test failed:', error);
                results.innerHTML += `<p>❌ Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
